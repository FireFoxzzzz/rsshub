services:
  rsshub:
    image: diygod/rsshub
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    env_file:
      - /etc/rsshub/.env
    restart: always
    ports:
      - '1200:1200'
    environment:
      NODE_ENV: production
      CACHE_TYPE: redis
      REDIS_URL: 'redis://redis:6379/'
      PUPPETEER_WS_ENDPOINT: 'ws://browserless:3000'
      PUPPETEER_REAL_BROWSER_SERVICE: 'http://real-browser:3000'
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:1200/healthz']
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      - redis
      - browserless
      - real-browser
    volumes:
      - /etc/ssl:/etc/ssl:ro

  real-browser:
    image: ghcr.io/hyoban/puppeteer-real-browser-hono
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    restart: always
    ports:
      - '3001:3000'
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3000']
      interval: 30s
      timeout: 10s
      retries: 3

  browserless:
    image: browserless/chrome
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    restart: always
    ulimits:
      core:
        hard: 0
        soft: 0
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3000/pressure']
      interval: 30s
      timeout: 10s
      retries: 3

  redis:
    image: redis:alpine
    # 可选：如果你也希望 redis 自动更新，取消注释
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    restart: always
    volumes:
      - redis-data:/data
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 5s

volumes:
  redis-data:

